<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= trip.name %> ‚Äì Schedule</title>
  <link rel="stylesheet" href="/css/bootstrap.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      background-color: #fef9ef;
    }

    /* Navbar - matching home page */
    .navbar {
      background-color: #2d5f5d;
      padding: 1rem 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .navbar-brand {
      color: white !important;
      font-weight: 700;
      font-size: 1.5rem;
      transition: color 0.3s;
    }

    .navbar-brand:hover {
      color: #e8b4b8 !important;
    }

    .navbar-nav .nav-link {
      color: rgba(255,255,255,0.85) !important;
      margin: 0 0.5rem;
      transition: color 0.3s;
    }

    .navbar-nav .nav-link:hover {
      color: #e8b4b8 !important;
    }

    .navbar .btn {
      padding: 0.4rem 1.2rem;
      border-radius: 5px;
      margin-left: 0.5rem;
      font-weight: 500;
      transition: all 0.3s;
    }

    .navbar .btn-danger {
      background-color: #e8b4b8;
      border: none;
    }

    .navbar .btn-danger:hover {
      background-color: #d99fa4;
      transform: translateY(-2px);
    }

    .overlay {
      background-color: white;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-top: 2rem;
      border: 2px solid #e0e0e0;
    }

    .trip-header {
      background: linear-gradient(135deg, #2d5f5d 0%, #8b9d77 100%);
      color: white;
      padding: 2rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
    }

    .btn-light {
      background-color: #e8b4b8;
      border: none;
      color: #2d5f5d;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-light:hover {
      background-color: #d99fa4;
      color: #2d5f5d;
      transform: translateY(-2px);
    }

    .day-section {
      margin-bottom: 2rem;
    }

    .day-header {
      background: linear-gradient(135deg, #8b9d77 0%, #2d5f5d 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
    }

    .activity-card {
      background: white;
      border-left: 4px solid #8b9d77;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }

    .activity-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transform: translateX(4px);
    }

    .activity-time {
      color: #2d5f5d;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .activity-location {
      color: #6c757d;
      font-size: 0.85rem;
    }

    .suggestion-card {
      background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
      border-left: 4px solid #ffc107;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .vote-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .vote-btn {
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
    }

    .btn-success {
      background-color: #8b9d77;
      border: none;
    }

    .btn-success:hover {
      background-color: #748361;
    }

    .vote-count {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .progress-thin {
      height: 8px;
      margin-top: 0.5rem;
    }

    .progress-bar.bg-success {
      background-color: #8b9d77 !important;
    }

    .add-activity-form {
      background-color: #f8f9fa;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-top: 2rem;
      border: 2px solid #e0e0e0;
    }

    .add-activity-form h5 {
      color: #2d5f5d;
    }

    .btn-primary {
      background-color: #8b9d77;
      border: none;
      padding: 0.6rem 2rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background-color: #748361;
      transform: translateY(-2px);
    }

    .location-input-wrapper {
      position: relative;
    }

    #location-suggestions {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 0.375rem;
      margin-top: 0.25rem;
      max-width: 100%;
    }

    #location-suggestions .list-group-item {
      cursor: pointer;
      border: 1px solid #dee2e6;
      padding: 0.75rem;
    }

    #location-suggestions .list-group-item:hover {
      background-color: #f8f9fa;
    }

    .location-name {
      font-weight: 600;
      color: #212529;
    }

    .location-details {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .map-container {
      background-color: #f8f9fa;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 2px solid #e0e0e0;
    }

    .map-container h4 {
      color: #2d5f5d;
    }
    
    #trip-map {
      height: 400px;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    footer {
      background-color: #2d5f5d;
      color: #fef9ef;
      padding: 1.5rem 0;
      text-align: center;
      margin-top: 3rem;
      border-top: 3px solid #c17767;
    }

    @media (max-width: 767px) {
      .overlay {
        padding: 1rem;
      }

      .trip-header {
        padding: 1.5rem;
      }

      #trip-map {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="/">TravelBuddy</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/profile">Your Profile</a></li>
          <li class="nav-item"><a class="nav-link" href="/groups">Groups</a></li>
          <li class="nav-item"><a class="nav-link" href="/schedule">Schedule</a></li>
          <li class="nav-item"><a class="nav-link btn btn-danger ms-2" href="/logout">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="overlay">
      <div class="trip-header">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h2 class="fw-bold mb-2"><%= trip.name %></h2>
            <% if (trip.destination) { %>
              <p class="mb-2 opacity-75">üìç <%= trip.destination %></p>
            <% } %>
            <p class="mb-0 opacity-75">
              üìÖ <%= new Date(trip.start_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %>
              - 
              <%= new Date(trip.end_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %>
            </p>
          </div>
          <div><a href="/groups/<%= group.id %>" class="btn btn-light">‚Üê Back to Group</a></div>
        </div>
      </div>

      <% if (message) { %>
        <div class="alert alert-info alert-dismissible fade show" role="alert">
          <%= message %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <div class="map-container">
        <h4 class="fw-bold mb-3">Activity Locations</h4>
        <div id="trip-map"></div>
      </div>

      <!-- Pending Suggestions -->
      <% if (suggestions && suggestions.length > 0) { %>
        <div class="mb-4">
          <h4 class="fw-bold mb-3" style="color: #2d5f5d;">Pending Activity Suggestions</h4>
          <p class="text-muted small">Needs <%= votesNeeded %> "Yes" votes out of <%= totalMembers %> members to be approved</p>
          
          <% suggestions.forEach(suggestion => { %>
            <div class="suggestion-card">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <% if (suggestion.start_time && suggestion.end_time) { %>
                    <div class="activity-time mb-1">üïê <%= suggestion.start_time %> - <%= suggestion.end_time %></div>
                  <% } %>
                  <h6 class="mb-1"><%= suggestion.title %></h6>
                  <small class="text-muted">üìÖ <%= new Date(suggestion.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></small>
                  <% if (suggestion.location) { %>
                    <div class="activity-location mb-1">üìç <%= suggestion.location %></div>
                  <% } %>
                  <% if (suggestion.description) { %>
                    <p class="text-muted mb-1 small"><%= suggestion.description %></p>
                  <% } %>
                  <small class="text-muted">Suggested by <%= suggestion.suggester_name || 'Unknown' %></small>
                  
                  <!-- Vote Progress -->
                  <div class="progress progress-thin">
                    <% const progressPercent = Math.min((suggestion.yesVotes / votesNeeded * 100), 100); %>
                    <div class="progress-bar bg-success" style="width: <%= progressPercent %>%"></div>
                  </div>
                  <div class="vote-count mt-1">
                    üëç <%= suggestion.yesVotes %> / <%= votesNeeded %> votes needed
                  </div>
                </div>  
                <div class="ms-3">
                  <div class="vote-section flex-column">
                    <% if (suggestion.userVote === 'yes') { %>
                      <span class="badge bg-success mb-2">You voted Yes ‚úì</span>
                    <% } else if (suggestion.userVote === 'no') { %>
                      <span class="badge bg-danger mb-2">You voted No ‚úó</span>
                    <% } %>
                    
                    <form action="/suggestions/<%= suggestion.id %>/vote" method="POST" class="d-inline">
                      <input type="hidden" name="vote" value="yes" />
                      <button type="submit" class="btn btn-success vote-btn <%= suggestion.userVote === 'yes' ? 'disabled' : '' %>">
                        üëç Yes
                      </button>
                    </form>
                    
                    <form action="/suggestions/<%= suggestion.id %>/vote" method="POST" class="d-inline">
                      <input type="hidden" name="vote" value="no" />
                      <button type="submit" class="btn btn-danger vote-btn <%= suggestion.userVote === 'no' ? 'disabled' : '' %>">
                        üëé No
                      </button>
                    </form>
                    
                    <% if (isAdmin || suggestion.suggested_by === user.id) { %>
                      <form action="/suggestions/<%= suggestion.id %>/delete" method="POST" class="d-inline mt-2" onsubmit="return confirm('Delete this suggestion?')">
                        <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                      </form>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>

      <!-- Timeline -->
      <h4 class="fw-bold mb-3" style="color: #2d5f5d;">Confirmed Schedule</h4>
      <div class="timeline">
        <% 
          const startDate = new Date(trip.start_date);
          const endDate = new Date(trip.end_date);
          const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
          
          for (let i = 0; i < daysDiff; i++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);
            const dateString = currentDate.toISOString().split('T')[0];
            const dayActivities = activitiesByDate[dateString] || [];
        %>
        
        <div class="day-section">
          <div class="day-header">
            <h5 class="mb-0 fw-bold">
              Day <%= i + 1 %> - <%= currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) %>
            </h5>
          </div>

          <% if (dayActivities.length > 0) { %>
            <% dayActivities.forEach(activity => { %>
              <div class="activity-card">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <% if (activity.start_time && activity.end_time) { %>
                      <div class="activity-time mb-1">üïê <%= activity.start_time %> - <%= activity.end_time %></div>
                    <% } %>
                    <h6 class="mb-1"><%= activity.title %></h6>
                    <% if (activity.location) { %>
                      <div class="activity-location mb-1">üìç <%= activity.location %></div>
                    <% } %>
                    <% if (activity.description) { %>
                      <p class="text-muted mb-1 small"><%= activity.description %></p>
                    <% } %>
                    <small class="text-muted">Added by <%= activity.creator_name || 'Unknown' %></small>
                  </div>
                  
                  <% if (isAdmin || activity.created_by === user.id) { %>
                    <form action="/activities/<%= activity.id %>/delete" method="POST" class="d-inline" onsubmit="return confirm('Delete this activity?')">
                      <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                    </form>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-muted ms-3">No activities confirmed for this day yet.</p>
          <% } %>
        </div>
        <% } %>
      </div>

      <!-- Suggest Activity Form -->
      <div class="add-activity-form">
        <h5 class="mb-3">Suggest New Activity</h5>
        <p class="text-muted small mb-3">Your suggestion will need <%= votesNeeded %> "Yes" votes from group members to be added to the schedule.</p>
        <form action="/trips/<%= trip.id %>/activities" method="POST">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="title" class="form-label">Activity Title *</label>
              <input type="text" id="title" name="title" class="form-control" placeholder="e.g., Visit Eiffel Tower" required />
            </div>
            <div class="col-md-3 mb-3">
              <label for="date" class="form-label">Date *</label>
              <input type="date" id="date" name="date" class="form-control" 
                     min="<%= trip.start_date %>" 
                     max="<%= trip.end_date %>" required />
            </div>
            <div class="col-md-3 mb-3">
              <label for="startTime" class="form-label">Start Time *</label>
              <input type="time" id="startTime" name="startTime" class="form-control" required />
            </div>
            <div class="col-md-3 mb-3">
              <label for="endTime" class="form-label">End Time *</label>
              <input type="time" id="endTime" name="endTime" class="form-control" required />
            </div>
          </div>

          <div class="mb-3 location-input-wrapper">
            <label for="location" class="form-label">Location</label>
            <input type="text" id="location" name="location" class="form-control" placeholder="Start typing a location..." autocomplete="off" />
            <input type="hidden" id="latitude" name="latitude" />
            <input type="hidden" id="longitude" name="longitude" />
            <div id="location-suggestions" class="list-group position-absolute" style="z-index: 1000; max-height: 300px; overflow-y: auto; display: none;"></div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea id="description" name="description" class="form-control" rows="2" placeholder="Additional details..."></textarea>
          </div>

          <button type="submit" class="btn btn-primary">Suggest Activity</button>
          <div class="mt-3 p-3 bg-light border-start border-4 rounded" style="border-color: #8b9d77 !important;">
            <small class="text-muted">
              <strong>Tip:</strong> Fields marked with a * are mandatory!<br>
              <strong>Tip:</strong> Activities must have both start and end times to prevent scheduling conflicts. 
              Make sure your times don't overlap with existing activities on the same day! It is advised to keep track of
              traveling times aswell. <br>
              <strong>Warning:</strong> Not using the suggested locations when filling in the location field will result in that
              activity not appearing on the map. We recommend using the suggested locations for consistency.
            </small>
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="mb-0">¬© 2025 TravelBuddy</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const locationInput = document.getElementById('location');
  const latitudeInput = document.getElementById('latitude');
  const longitudeInput = document.getElementById('longitude');
  const suggestionsDiv = document.getElementById('location-suggestions');
  let debounceTimer;

  locationInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    clearTimeout(debounceTimer);
    
    if (query.length < 3) {
      suggestionsDiv.style.display = 'none';
      return;
    }
    
    debounceTimer = setTimeout(() => fetchLocations(query), 300);
  });

  async function fetchLocations(query) {
    try {
      const response = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5`);
      const data = await response.json();
      displaySuggestions(data.features);
    } catch (error) {
      console.error('Error fetching locations:', error);
      suggestionsDiv.style.display = 'none';
    }
  }

  function displaySuggestions(features) {
    if (!features || features.length === 0) {
      suggestionsDiv.style.display = 'none';
      return;
    }
    
    suggestionsDiv.innerHTML = '';
    
    features.forEach(feature => {
      const props = feature.properties;
      const coords = feature.geometry.coordinates;
      const item = document.createElement('div');
      item.className = 'list-group-item';
      
      let locationName = props.name || '';
      let locationDetails = [];
      
      if (props.city) locationDetails.push(props.city);
      if (props.state) locationDetails.push(props.state);
      if (props.country) locationDetails.push(props.country);
      
      item.innerHTML = `
        <div class="location-name">${locationName}</div>
        <div class="location-details">${locationDetails.join(', ')}</div>
      `;
      
      item.addEventListener('click', () => {
        const fullLocation = locationName + (locationDetails.length > 0 ? ', ' + locationDetails.join(', ') : '');
        locationInput.value = fullLocation;
        longitudeInput.value = coords[0];
        latitudeInput.value = coords[1];
        suggestionsDiv.style.display = 'none';
      });
      
      suggestionsDiv.appendChild(item);
    });
    
    suggestionsDiv.style.display = 'block';
  }

  document.addEventListener('click', function(e) {
    if (!locationInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = 'none';
    }
  });

  document.querySelector('.add-activity-form form').addEventListener('submit', function() {
    suggestionsDiv.style.display = 'none';
  });
</script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    const activities = <%- JSON.stringify(activities) %>;
    const locatedActivities = activities.filter(a => a.latitude && a.longitude);
    
    if (locatedActivities.length > 0) {
      const map = L.map('trip-map').setView([locatedActivities[0].latitude, locatedActivities[0].longitude], 12);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      const bounds = [];
      locatedActivities.forEach(activity => {
        const marker = L.marker([activity.latitude, activity.longitude]).addTo(map);
        
        const popupContent = `
          <strong>${activity.title}</strong><br>
          ${activity.location ? activity.location + '<br>' : ''}
          ${new Date(activity.date).toLocaleDateString()}<br>
          ${activity.start_time} - ${activity.end_time}
        `;
        
        marker.bindPopup(popupContent);
        bounds.push([activity.latitude, activity.longitude]);
      });
      
      if (bounds.length > 1) {
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    } else {
      document.getElementById('trip-map').innerHTML = '<div class="text-center p-5 text-muted">No activities with locations yet. Add activities with locations to see them on the map!</div>';
    }
  </script>
</body>
</html>