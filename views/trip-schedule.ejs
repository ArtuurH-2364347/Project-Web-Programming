<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= trip.name %> ‚Äì Schedule</title>
  <link rel="stylesheet" href="/css/bootstrap.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/css/trip-schedule.css" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="/">TravelBuddy</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/profile">Your Profile</a></li>
          <li class="nav-item"><a class="nav-link" href="/groups">Groups</a></li>
          <li class="nav-item"><a class="nav-link" href="/schedule">Schedule</a></li>
          <li class="nav-item"><a class="nav-link btn btn-danger ms-2" href="/logout">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="overlay">
      <div class="trip-header">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h2 class="fw-bold mb-2"><%= trip.name %></h2>
            <% if (trip.destination) { %>
              <p class="mb-2 opacity-75">üìç <%= trip.destination %></p>
            <% } %>
            <p class="mb-0 opacity-75">
              üìÖ <%= new Date(trip.start_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %>
              - 
              <%= new Date(trip.end_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %>
            </p>
          </div>
          <div><a href="/groups/<%= group.id %>" class="btn btn-light">‚Üê Back to Group</a></div>
        </div>
      </div>

      <% if (message) { %>
        <div class="alert alert-info alert-dismissible fade show" role="alert">
          <%= message %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <div class="map-container">
        <h4 class="fw-bold mb-3">Activity Locations</h4>
        <div id="trip-map"></div>
      </div>
      <% if (suggestions && suggestions.length > 0) { %>
        <div class="mb-4">
          <h4 class="fw-bold mb-3" style="color: #2d5f5d;">Pending Activity Suggestions</h4>
          <p class="text-muted small">Needs <%= votesNeeded %> "Yes" votes out of <%= totalMembers %> members to be approved</p>
          
          <% suggestions.forEach(suggestion => { %>
            <div class="suggestion-card">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <% if (suggestion.start_time && suggestion.end_time) { %>
                    <div class="activity-time mb-1">üïê <%= suggestion.start_time %> - <%= suggestion.end_time %></div>
                  <% } %>
                  <h6 class="mb-1"><%= suggestion.title %></h6>
                  <small class="text-muted">üìÖ <%= new Date(suggestion.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></small>
                  <% if (suggestion.location) { %>
                    <div class="activity-location mb-1">üìç <%= suggestion.location %></div>
                  <% } %>
                  <% if (suggestion.description) { %>
                    <p class="text-muted mb-1 small"><%= suggestion.description %></p>
                  <% } %>
                  <small class="text-muted">Suggested by <%= suggestion.suggester_name || 'Unknown' %></small>
              
                  <div class="progress progress-thin">
                    <% const progressPercent = Math.min((suggestion.yesVotes / votesNeeded * 100), 100); %>
                    <div class="progress-bar bg-success" style="width: <%= progressPercent %>%"></div>
                  </div>
                  <div class="vote-count mt-1">
                    üëç <%= suggestion.yesVotes %> / <%= votesNeeded %> votes needed
                  </div>
                </div>  
                <div class="ms-3">
                  <div class="vote-section flex-column">
                    <% if (suggestion.userVote === 'yes') { %>
                      <span class="badge bg-success mb-2">You voted Yes ‚úì</span>
                    <% } else if (suggestion.userVote === 'no') { %>
                      <span class="badge bg-danger mb-2">You voted No ‚úó</span>
                    <% } %>
                    
                    <form action="/suggestions/<%= suggestion.id %>/vote" method="POST" class="d-inline">
                      <input type="hidden" name="vote" value="yes" />
                      <button type="submit" class="btn btn-success vote-btn <%= suggestion.userVote === 'yes' ? 'disabled' : '' %>">
                        üëç Yes
                      </button>
                    </form>
                    
                    <form action="/suggestions/<%= suggestion.id %>/vote" method="POST" class="d-inline">
                      <input type="hidden" name="vote" value="no" />
                      <button type="submit" class="btn btn-danger vote-btn <%= suggestion.userVote === 'no' ? 'disabled' : '' %>">
                        üëé No
                      </button>
                    </form>
                    
                    <% if (isAdmin || suggestion.suggested_by === user.id) { %>
                      <button 
                        class="btn btn-outline-danger btn-sm mt-2" 
                        data-bs-toggle="modal" 
                        data-bs-target="#deleteSuggestionModal<%= suggestion.id %>"
                      >
                        Delete
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          
            <div class="modal fade" id="deleteSuggestionModal<%= suggestion.id %>" tabindex="-1" aria-labelledby="deleteSuggestionModalLabel<%= suggestion.id %>" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteSuggestionModalLabel<%= suggestion.id %>">
                      Delete Suggestion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p class="mb-3">Are you sure you want to delete <strong>"<%= suggestion.title %>"</strong>?</p>
                    <div class="alert alert-warning" role="alert">
                      <strong>Warning:</strong> This action cannot be undone. All votes associated with this suggestion will be permanently deleted.
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="/suggestions/<%= suggestion.id %>/delete" method="POST" class="d-inline">
                      <button type="submit" class="btn btn-danger">Delete Suggestion</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>


      <h4 class="fw-bold mb-3" style="color: #2d5f5d;">Confirmed Schedule</h4>
      <div class="timeline">
        <% 
          const startDate = new Date(trip.start_date);
          const endDate = new Date(trip.end_date);
          const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
          
          for (let i = 0; i < daysDiff; i++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);
            const dateString = currentDate.toISOString().split('T')[0];
            const dayActivities = activitiesByDate[dateString] || [];
        %>
        
        <div class="day-section">
          <div class="day-header">
            <h5 class="mb-0 fw-bold">
              Day <%= i + 1 %> - <%= currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) %>
            </h5>
          </div>

          <% if (dayActivities.length > 0) { %>
            <% dayActivities.forEach(activity => { %>
              <div class="activity-card">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <% if (activity.start_time && activity.end_time) { %>
                      <div class="activity-time mb-1">üïê <%= activity.start_time %> - <%= activity.end_time %></div>
                    <% } %>
                    <h6 class="mb-1"><%= activity.title %></h6>
                    <% if (activity.location) { %>
                      <div class="activity-location mb-1">üìç <%= activity.location %></div>
                    <% } %>
                    <% if (activity.description) { %>
                      <p class="text-muted mb-1 small"><%= activity.description %></p>
                    <% } %>
                    <small class="text-muted">Added by <%= activity.creator_name || 'Unknown' %></small>
                  </div>
                  
                  <% if (isAdmin || activity.created_by === user.id) { %>
                    <button 
                      class="btn btn-outline-danger btn-sm" 
                      data-bs-toggle="modal" 
                      data-bs-target="#deleteActivityModal<%= activity.id %>"
                    >
                      Delete
                    </button>
                  <% } %>
                </div>
              </div>
              
              <div class="modal fade" id="deleteActivityModal<%= activity.id %>" tabindex="-1" aria-labelledby="deleteActivityModalLabel<%= activity.id %>" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                      <h5 class="modal-title" id="deleteActivityModalLabel<%= activity.id %>">
                        Delete Activity
                      </h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p class="mb-3">Are you sure you want to delete <strong>"<%= activity.title %>"</strong>?</p>
                      <div class="alert alert-warning" role="alert">
                        <strong>Warning:</strong> This action cannot be undone. This activity will be permanently removed from the schedule.
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <form action="/activities/<%= activity.id %>/delete" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger">Delete Activity</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-muted ms-3">No activities confirmed for this day yet.</p>
          <% } %>
        </div>
        <% } %>
      </div>
      <div class="add-activity-form">
        <h5 class="mb-3">Suggest New Activity</h5>
        <p class="text-muted small mb-3">Your suggestion will need <%= votesNeeded %> "Yes" votes from group members to be added to the schedule.</p>
        <form action="/trips/<%= trip.id %>/activities" method="POST">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="title" class="form-label">Activity Title *</label>
              <input type="text" id="title" name="title" class="form-control" placeholder="e.g., Visit Eiffel Tower" required />
            </div>
            <div class="col-md-3 mb-3">
              <label for="date" class="form-label">Date *</label>
              <input type="date" id="date" name="date" class="form-control" 
                     min="<%= trip.start_date %>" 
                     max="<%= trip.end_date %>" required />
            </div>
            <div class="col-md-3 mb-3">
              <label for="startTime" class="form-label">Start Time *</label>
              <input type="time" id="startTime" name="startTime" class="form-control" required />
            </div>
            <div class="col-md-3 mb-3">
              <label for="endTime" class="form-label">End Time *</label>
              <input type="time" id="endTime" name="endTime" class="form-control" required />
            </div>
          </div>

          <div class="mb-3 location-input-wrapper">
            <label for="location" class="form-label">Location</label>
            <input type="text" id="location" name="location" class="form-control" placeholder="Start typing a location..." autocomplete="off" />
            <input type="hidden" id="latitude" name="latitude" />
            <input type="hidden" id="longitude" name="longitude" />
            <div id="location-suggestions" class="list-group position-absolute" style="z-index: 1000; max-height: 300px; overflow-y: auto; display: none;"></div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea id="description" name="description" class="form-control" rows="2" placeholder="Additional details..."></textarea>
          </div>

          <button type="submit" class="btn btn-primary">Suggest Activity</button>
          <div class="mt-3 p-3 bg-light border-start border-4 rounded" style="border-color: #8b9d77 !important;">
            <small class="text-muted">
              <strong>Tip:</strong> Fields marked with a * are mandatory!<br>
              <strong>Tip:</strong> Activities must have both start and end times to prevent scheduling conflicts. 
              Make sure your times don't overlap with existing activities on the same day! It is advised to keep track of
              traveling times aswell. <br>
              <strong>Warning:</strong> Not using the suggested locations when filling in the location field will result in that
              activity not appearing on the map. We recommend using the suggested locations for consistency.
            </small>
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="mb-0">¬© 2025 TravelBuddy</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    window.tripActivities = <%- JSON.stringify(activities) %>;
  </script>
  <script src="/js/trip-schedule.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      initializeMap(window.tripActivities);
    });
  </script>

</body>
</html>